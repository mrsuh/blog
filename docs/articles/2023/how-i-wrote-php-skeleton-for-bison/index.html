<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="author" content="Anton Sukhachev">
    <title>How I Wrote PHP Skeleton For Bison</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

    <meta name="description" content="devm.io/php/php-skeleton-bison-generics Do you dream of generics in PHP? I wanted it so much - I mad..."/>
    <meta name="keywords" content="php, bison, skeleton"/>

    <meta property="og:type" content="website">
    <meta property="og:site_name" content="mrsuh.com">
    <meta property="og:url" content="https://mrsuh.com/articles/2023/how-i-wrote-php-skeleton-for-bison/">
    <meta property="og:title" content="How I Wrote PHP Skeleton For Bison">
    <meta property="og:description" content="devm.io/php/php-skeleton-bison-generics Do you dream of generics in PHP? I wanted it so much - I mad...">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:alt" content="Anton Sukhachev">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="mrsuh.com">
    <meta name="twitter:url" content="https://mrsuh.com/articles/2023/how-i-wrote-php-skeleton-for-bison/">
    <meta name="twitter:title" content="How I Wrote PHP Skeleton For Bison">
    <meta name="twitter:creator" content="@mrsuh6">
    <meta name="twitter:description" content="devm.io/php/php-skeleton-bison-generics Do you dream of generics in PHP? I wanted it so much - I mad...">
    <meta name="twitter:image:alt" content="Anton Sukhachev">
    
    <link href="/bootstrap.min.css" rel="stylesheet">
    <link href="/style.css?v=4" rel="stylesheet">
    <script>
        if (!window.location.host.includes('127.0.0.1') && !window.location.host.includes('localhost')) {
            !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_D8fuOCgUvowJZQavoR29IHq7FQcZMWByA9mtvPq5PIg',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' // or 'always' to create profiles for anonymous users as well
            })
        }
    </script>
</head>

<body class="container fs-5" style="max-width: 1000px">

<div class="header" style="padding-top: 20px; padding-bottom: 10px">
    <div class="row">
        <div class="col">
            <a href="/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Anton Sukhachev</a>
        </div>
        <div class="col text-end">
            <a href="/articles/" class="link-primary link-underline-opacity-100">Articles</a>
            <a href="/projects/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Projects</a>
        </div>
    </div>
    <hr/>
</div>

<div class="content">
    <h1>How I Wrote PHP Skeleton For Bison</h1>
<p><a href="https://devm.io/php/php-skeleton-bison-generics" class="link-secondary" target="_blank">devm.io/php/php-skeleton-bison-generics</a></p>
<p>Do you dream of generics in PHP?<br><br />
I wanted it so much - I made a library that brings generics in PHP.</p>
<pre><code class="language-php rounded">&lt;?php

namespace App;

class Box&lt;T&gt; {

    private ?T $data = null;

    public function set(T $data): void {
        $this-&gt;data = $data;
    }

    public function get(): ?T {
        return $this-&gt;data;
    }
}</code></pre>
<p>If you are interested you can <a href="https://github.com/mrsuh/php-generics" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">test it</a>. Only native PHP is required (without extensions).<br><br />
But in this article, I want to tell you about a very important part of my library - <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">AST</a> parser.<br><br />
I use a very popular library <a href="https://github.com/nikic/PHP-Parser" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">nikic/php-parser</a>. Many other software uses it.<br><br />
It helps you to build AST from source code like this:</p>
<pre><code class="language-php rounded">&lt;?php

namespace App;

class Test
{
    public function test($foo) {}
}</code></pre>
<pre><code class="language-bash rounded">.
├── ZEND_AST_STMT_LIST
    ├── ZEND_AST_NAMESPACE
    │   └── ZEND_AST_ZVAL 'App'
    └── ZEND_AST_CLASS 'Test'
        └── ZEND_AST_STMT_LIST
            └── ZEND_AST_METHOD 'test'
                └── ZEND_AST_PARAM_LIST
                    └── ZEND_AST_PARAM
                        └── ZEND_AST_ZVAL 'foo'</code></pre>
<p>Every AST parser has a lexical analyzer, syntax analyzer, and AST builder. Usually, it grouped into Lexer and Parser.</p>
<p><a href="./images/ast-builder.png"><img src="./images/ast-builder.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<p>You don't need to write Lexer and Parser from scratch.<br><br />
To build Lexer you can use tools:</p>
<ul>
<li><a href="https://re2c.org" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">re2c</a> - PHP engine uses it to parse source code</li>
<li><a href="https://www.php.net/manual/en/function.token-get-all.php" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">get_token_all()</a> - php-parser uses this function to parse source code</li>
<li><a href="https://github.com/doctrine/lexer" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">doctrine lexer</a> - doctrine uses it to parse annotations</li>
</ul>
<p>How do Lexers work?</p>
<p><a href="./images/lexer.png"><img src="./images/lexer.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<p>Lexers help you to parse text into tokens.<br><br />
For example PHP engine's Lexer use <a href="https://re2c.org" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">re2c</a>.</p>
<p><a href="https://github.com/php/php-src/blob/master/Zend/zend_language_scanner.l" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">php-src Lexer example</a></p>
<pre><code class="language-c rounded">/*!re2c
re2c:yyfill:check = 0;
LNUM    [0-9]+(_[0-9]+)*
DNUM    ({LNUM}?"."{LNUM})|({LNUM}"."{LNUM}?)

&lt;ST_IN_SCRIPTING&gt;"exit" {
    RETURN_TOKEN_WITH_IDENT(T_EXIT);
}

&lt;ST_IN_SCRIPTING&gt;"return" {
    RETURN_TOKEN_WITH_IDENT(T_RETURN);
}
*/</code></pre>
<p>Below you can see PHP code and tokens from Lexer.</p>
<pre><code class="language-bash rounded">&lt;?php    |   T_OPEN_TAG
         |   T_WHITESPACE
$a = 1;  |   T_VARIABLE T_WHITESPACE = T_WHITESPACE T_LNUMBER ;
         |   T_WHITESPACE
echo $a; |   T_ECHO T_WHITESPACE T_VARIABLE ;</code></pre>
<p>We can think about PHP engine and php-parser Lexers as similar Lexers because function <code>get_token_all()</code> calls <code>re2c</code> functions under the hood.<br><br />
After the Lexer we have tokens, and we need a Parser to build AST.</p>
<p>To build Parser you can use the tools:</p>
<ul>
<li><a href="https://www.gnu.org/software/bison/" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Bison</a> - PHP engine uses it</li>
<li><a href="https://github.com/ircmaxell/PHP-Yacc" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">KmYacc</a> - php-parser uses it</li>
<li><a href="https://www.antlr.org" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">ANTLR</a> - Twitter search uses ANTLR for query parsing</li>
</ul>
<p>How do parser generators work?</p>
<p><a href="./images/parser-generator.png"><img src="./images/parser-generator.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<p>A generator takes your <code>grammar.y</code> <a href="https://en.wikipedia.org/wiki/Backus–Naur_form" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">BNF</a> file, parses it, extracts all definitions, and then constructs a bunch of tables like this:</p>
<pre><code class="language-php rounded">$yytable = [
    6, 3, 7, 20, 8, 51, 28, 1, 52, 4,
    9, 13, 10, 29, 15, 30, 18, 31, 16, 19,
    32, 22, 33, 34, 23, 24, 35, 11, 37, 25,
    21, 38, 39, 26, 45, 0, 40, 42, 0, 43,
    41, 0, 0, 49, 0, 0, 0, 0, 0, 47,
    48, 0, 50, 0, 53, 54
];</code></pre>
<p>Then, this data is passed to a template that is called a <code>Skeleton</code>.<br><br />
For Bison, <code>Skeleton</code> is a special file written in <a href="https://en.wikipedia.org/wiki/M4_(computer_language)" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">M4</a> language that renders your <code>parser</code> file.<br><br />
By default, Bison Skeletons supports C/C++/D/Java languages.</p>
<p>PHP engine and php-parser use different parser generators but use very similar grammar files.</p>
<p><a href="https://github.com/php/php-src/blob/master/Zend/zend_language_parser.y" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">php-src grammar example</a></p>
<pre><code class="language-bnf rounded">statement:
    |   T_BREAK optional_expr ';'    { $$ = zend_ast_create(ZEND_AST_BREAK, $2); }
    |   T_CONTINUE optional_expr ';' { $$ = zend_ast_create(ZEND_AST_CONTINUE, $2); }
    |   T_RETURN optional_expr ';'   { $$ = zend_ast_create(ZEND_AST_RETURN, $2); }</code></pre>
<p><a href="https://github.com/nikic/PHP-Parser/blob/4.x/grammar/php7.y" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">php-parser grammar example</a></p>
<pre><code class="language-bnf rounded">non_empty_statement:
    |   T_BREAK optional_expr semi    { $$ = Stmt\Break_[$2]; }
    |   T_CONTINUE optional_expr semi { $$ = Stmt\Continue_[$2]; }
    |   T_RETURN optional_expr semi   { $$ = Stmt\Return_[$2]; }</code></pre>
<p>After all this information about parsers, we can summarize it on the scheme:</p>
<p><a href="./images/bison-kmyacc.png"><img src="./images/bison-kmyacc.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<p>I had thought about replacing <code>KmYacc</code> with <code>Bison</code> in php-parser.<br><br />
It is great for PHP engine and php-parser to use the same tools to make the same job.<br><br />
Even the fact, that Bison doesn't have PHP Skeleton didn't stop me.<br><br />
I decided to create my own skeleton.<br><br />
I translated Java skeleton to PHP. It took a few months for me.<br><br />
Translating Java code to PHP is not very hard, but if your code is not written with m4 and has not very many options.</p>
<p><a href="https://github.com/akimd/bison/blob/master/data/skeletons/lalr1.java" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Java-skeleton example</a></p>
<pre><code class="language-bash rounded">]b4_yystype[ lval = yylexer.getLVal();]b4_locations_if([[
]b4_location_type[ yyloc = new ]b4_location_type[(yylexer.getStartPos(), yylexer.getEndPos());
status = push_parse(token, lval, yyloc);]], [[
status = push_parse(token, lval);]])[</code></pre>
<p><a href="https://github.com/mrsuh/php-bison-skeleton/blob/master/src/lalr1.php" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">PHP-skeleton example</a></p>
<pre><code class="language-bash rounded">/** @@var ]b4_yystype[ */
$lval = $this-&gt;yylexer-&gt;getLVal();]b4_locations_if([[
/** @@var ]b4_location_type[ */
$yyloc = new ]b4_location_type[($this-&gt;yylexer-&gt;getStartPos(), $this-&gt;yylexer-&gt;getEndPos());
$status = $this-&gt;push_parse($token, $lval, $yyloc);]], [[
$status = $this-&gt;push_parse($token, $lval);]])[</code></pre>
<p>After a few months and many auto tests <a href="https://github.com/mrsuh/php-bison-skeleton" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">php-skeleton</a> was ready!</p>
<pre><code class="language-bash rounded">[php-bison-skeleton] composer test
&gt; php vendor/bin/phpunit
PHPUnit 9.6.5 by Sebastian Bergmann and contributors.

................................................................. 65 / 72 ( 90%)
.......                                                           72 / 72 (100%)

Time: 00:04.037, Memory: 6.00 MB

OK (72 tests, 384 assertions)</code></pre>
<p>Then I tried to replace <code>KmYacc</code> with <code>Bison</code>.<br><br />
You can reproduce the replacement with the steps:</p>
<ul>
<li>
<p>install required libraries:</p>
<pre><code class="language-bash rounded">composer require --dev mrsuh/php-bison-skeleton
composer require nikic/php-parser</code></pre>
</li>
<li>
<p>generate grammar file of php-parser:</p>
<pre><code class="language-bash rounded">cd vendor/nikic/php-parser/
composer install
php grammar/rebuildParsers.php --keep-tmp-grammar
cp grammar/tmp_parser.phpy ../../../../../examples/php/nikic-grammar.y</code></pre>
</li>
<li>
<p>replace the dollar sign before Bison generate Parser and replace it back after because Bison <a href="https://github.com/akimd/bison/issues/100" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">doesn't support dollar sign</a> in the grammar:</p>
<pre><code class="language-bash rounded">php bin/replace-dollar-sign.php in nikic-grammar.y nikic-grammar-replaced.y
bison -S ../../src/php-skel.m4 -o lib/parser-tmp.php nikic-grammar-replaced.y
php bin/replace-dollar-sign.php out lib/parser-tmp.php lib/parser.php</code></pre>
</li>
</ul>
<p>Great! The parser is ready.</p>
<p>Time to compare PHP parser generated with <code>Bison</code> and <code>KmYacc</code>.<br><br />
I had run tests with 3 different files sizes and different PHP versions (smaller is better):</p>
<a href="#h4-[php-file-684-bytes](https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/bin/parse-bison.php)" id="h4-[php-file-684-bytes](https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/bin/parse-bison.php)" class="text-decoration-none text-reset"><h4><a href="https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/bin/parse-bison.php" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">PHP file 684 bytes</a></h4></a>
<p><a href="./images/chart-little.png"><img src="./images/chart-little.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<a href="#h4-[php-file-8.8-kilobytes](https://github.com/nikic/php-parser/blob/4.x/lib/phpparser/lexer/emulative.php)" id="h4-[php-file-8.8-kilobytes](https://github.com/nikic/php-parser/blob/4.x/lib/phpparser/lexer/emulative.php)" class="text-decoration-none text-reset"><h4><a href="https://github.com/nikic/PHP-Parser/blob/4.x/lib/PhpParser/Lexer/Emulative.php" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">PHP file 8.8 kilobytes</a></h4></a>
<p><a href="./images/chart-mid.png"><img src="./images/chart-mid.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<a href="#h4-[php-file-329-kilobytes](https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/lib/parser.php)" id="h4-[php-file-329-kilobytes](https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/lib/parser.php)" class="text-decoration-none text-reset"><h4><a href="https://github.com/mrsuh/php-bison-skeleton/blob/master/examples/php/lib/parser.php" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">PHP file 329 kilobytes</a></h4></a>
<p><a href="./images/chart-big.png"><img src="./images/chart-big.png" alt="" class="img-fluid mx-auto d-block rounded img-size" /></a></p>
<p>As you can see performance of the parser generated with <code>Bison</code> is slower than the parser generated with <code>KmYacc</code>.<br><br />
I tried to optimize generated parser code, but it gave maximum  ~15 percent improvement. Not such much.<br></p>
<p>In the end, I replaced <code>KmYacc</code> with <code>Bison</code> in php-parser, but it works not such well as I imagined.<br><br />
Now I have a well-working php-skeleton for <code>Bison</code>.<br><br />
Maybe next time I'll try to replace <code>KmYacc</code> with <code>ANTLR</code>.</p>
<p>You can found php-bison-skeleton, many examples and tests into this <a href="https://github.com/mrsuh/php-bison-skeleton" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">repository</a></p>
<p>Thank you for your time. Hope you find this article useful.</p>
</div>

<div class="footer" style="height: 40px"></div>
</body>
<link rel="stylesheet" href="/highlight.github-dark-dimmed.min.css">
<script src="/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

</html>
