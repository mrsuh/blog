<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="author" content="Anton Sukhachev">
    <title>PHP Generics</title>
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>

    <meta name="description" content="Real PHP generics implemented in PHP with RFC-style syntax <b>Class&lt;T&gt;</b> and runtime type ch..."/>
    <meta name="keywords" content="nginx, lua, redis, php, session"/>

    <meta property="og:type" content="website">
    <meta property="og:site_name" content="mrsuh.com">
    <meta property="og:url" content="https://mrsuh.com/projects/php-generics/">
    <meta property="og:title" content="PHP Generics">
    <meta property="og:description" content="Real PHP generics implemented in PHP with RFC-style syntax <b>Class&lt;T&gt;</b> and runtime type ch...">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:alt" content="Anton Sukhachev">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="mrsuh.com">
    <meta name="twitter:url" content="https://mrsuh.com/projects/php-generics/">
    <meta name="twitter:title" content="PHP Generics">
    <meta name="twitter:creator" content="@mrsuh6">
    <meta name="twitter:description" content="Real PHP generics implemented in PHP with RFC-style syntax <b>Class&lt;T&gt;</b> and runtime type ch...">
    <meta name="twitter:image:alt" content="Anton Sukhachev">
    
    <link href="/bootstrap.min.css" rel="stylesheet">
    <link href="/style.css?v=4" rel="stylesheet">
    <script>
        if (!window.location.host.includes('127.0.0.1') && !window.location.host.includes('localhost')) {
            !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
            posthog.init('phc_D8fuOCgUvowJZQavoR29IHq7FQcZMWByA9mtvPq5PIg',{api_host:'https://eu.i.posthog.com', person_profiles: 'identified_only' // or 'always' to create profiles for anonymous users as well
            })
        }
    </script>
</head>

<body class="container fs-5" style="max-width: 1000px">

<div class="header" style="padding-top: 20px; padding-bottom: 10px">
    <div class="row">
        <div class="col">
            <a href="/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Anton Sukhachev</a>
        </div>
        <div class="col text-end">
            <a href="/articles/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Articles</a>
            <a href="/projects/" class="link-primary link-underline-opacity-100">Projects</a>
        </div>
    </div>
    <hr/>
</div>

<div class="content">
    <h1>PHP Generics</h1>
<p>Here’s an example of how the <a href="https://github.com/mrsuh/php-generics" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">PHP Generics library</a> works:</p>
<pre><code class="language-php rounded">&lt;?php

namespace App;

class Box&lt;T&gt; {

   private ?T $data = null;

   public function set(T $data): void {
       $this-&gt;data = $data;
   }

   public function get(): ?T {
       return $this-&gt;data;
   }
}</code></pre>
<pre><code class="language-php rounded">&lt;?php

namespace App;

class Usage {

   public function run(): void
   {
       $stringBox = new Box&lt;string&gt;();
       $stringBox-&gt;set('cat');
       var_dump($stringBox-&gt;get()); // string "cat"

       $intBox = new Box&lt;int&gt;();
       $intBox-&gt;set(1);
       var_dump($intBox-&gt;get()); // integer 1
   }
}</code></pre>
<p>The library uses <code>monomorphization</code> to implement generics in PHP.<br />
You can <a href="/articles/2022/generics-implementation-approaches/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">read more</a> about the different approaches to implementing generics.</p>
<a href="#h2-how-it-works" id="h2-how-it-works" class="text-decoration-none text-reset"><h2>How It Works</h2></a>
<p>The library generates concrete classes from generic classes with unique names based on the name and arguments of the generic class. These classes are stored in the <code>cache</code> folder:</p>
<pre><code class="language-php rounded">Box&lt;string&gt; -&gt; BoxForString
Box&lt;int&gt; -&gt; BoxForInt        </code></pre>
<p>Composer then autoloads the concrete classes instead of the original generic classes.</p>
<pre><code class="language-json rounded">{
   "autoload": {
       "psr-4": {
           "App\\": ["cache/","src/"]
       }
   }
}</code></pre>
<p><a href="/articles/2022/how-php-engine-builds-ast/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">Learn more</a> about how the library works in this article or check out <a href="https://phprussia.ru/moscow/2022/abstracts/9165" target="_blank" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">these slides</a>.</p>
<a href="#h2-memory-usage" id="h2-memory-usage" class="text-decoration-none text-reset"><h2>Memory Usage</h2></a>
<p><em>Items in collection: 10000</em></p>
<table class="table table-bordered">
<thead class="table-secondary">
<tr>
<th>type</th>
<th>var_class_sizeof(bytes)</th>
<th>var_sizeof(bytes)</th>
<th>memory_get_usage(bytes)</th>
</tr>
</thead>
<tbody>
<tr>
<td>array(count: 10000)</td>
<td>0</td>
<td>822,224</td>
<td>1,051,320</td>
</tr>
<tr>
<td>psalm(count: 10000)</td>
<td>1,510</td>
<td>822,432</td>
<td>1,051,560</td>
</tr>
<tr>
<td>monomorphic(count: 10000)</td>
<td>1,528</td>
<td>822,432</td>
<td>1,051,560</td>
</tr>
<tr>
<td>type-erased(count: 10000)</td>
<td>1,512</td>
<td>822,432</td>
<td>1,051,560</td>
</tr>
</tbody>
</table>
<a href="#h2-performance" id="h2-performance" class="text-decoration-none text-reset"><h2>Performance</h2></a>
<pre><code class="language-bash rounded">PHPBench (1.2.3) running benchmarks...
with configuration file: /app/phpbench.json
with PHP version 8.1.3, xdebug ❌, opcache ❌

\App\Tests\TypHintBench

    benchWithoutType........................R1 I6 - Mo240.713μs (±0.47%)
    benchWithArrayType......................R1 I70 - Mo247.663μs (±0.45%)
    benchWithMixedType......................R2 I59 - Mo249.293μs (±0.54%)
    benchWithClassType......................R1 I26 - Mo306.533μs (±0.48%)

Subjects: 4, Assertions: 0, Failures: 0, Errors: 0
+--------------+--------------------+-----+------+-----+-----------+-----------+--------+
| benchmark    | subject            | set | revs | its | mem_peak  | mode      | rstdev |
+--------------+--------------------+-----+------+-----+-----------+-----------+--------+
| TypHintBench | benchWithoutType   |     | 1000 | 100 | 674.272kb | 240.713μs | ±0.47% |
| TypHintBench | benchWithArrayType |     | 1000 | 100 | 674.272kb | 247.663μs | ±0.45% |
| TypHintBench | benchWithMixedType |     | 1000 | 100 | 674.272kb | 249.293μs | ±0.54% |
| TypHintBench | benchWithClassType |     | 1000 | 100 | 674.272kb | 306.533μs | ±0.48% |
+--------------+--------------------+-----+------+-----+-----------+-----------+--------+</code></pre>
<p>PHP uses dynamic typing, so it’s no surprise that adding types slightly reduces performance. Additionally, arrays consume less memory compared to class wrappers.<br />
You can <a href="/articles/2022/comparing-php-collections/" class="link-primary link-underline-opacity-0 link-underline-opacity-100-hover">read more</a> about performance and memory comparisons here.</p>
</div>

<div class="footer" style="height: 40px"></div>
</body>
<link rel="stylesheet" href="/highlight.github-dark-dimmed.min.css">
<script src="/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

</html>
